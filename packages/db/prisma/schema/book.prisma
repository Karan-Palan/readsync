enum FileType {
  PDF
  EPUB
}

enum AIAction {
  EXPLAIN
  SUMMARIZE
  EXTRACT
  DISCUSS
}

model Book {
  id         String    @id @default(cuid())
  userId     String
  title      String
  fileName   String
  fileUrl    String
  fileType   FileType
  coverUrl   String?
  totalPages Int?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  readingProgress  ReadingProgress[]
  highlights       Highlight[]
  chapters         Chapter[]
  summary          BookSummary?
  readingSessions  ReadingSession[]

  @@index([userId])
  @@map("book")
}

model BookSummary {
  id        String   @id @default(cuid())
  userId    String
  bookId    String   @unique
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("book_summary")
}

model ReadingProgress {
  id              String   @id @default(cuid())
  userId          String
  bookId          String
  position        Json
  highestPosition Json?
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([userId, bookId])
  @@index([userId])
  @@index([bookId])
  @@map("reading_progress")
}

model Highlight {
  id         String    @id @default(cuid())
  userId     String
  bookId     String
  text       String
  color      String    @default("yellow")
  note       String?
  startCfi   String?
  endCfi     String?
  pageNumber Int?
  aiAction   AIAction?
  aiResponse String?
  createdAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([bookId])
  @@map("highlight")
}

model Chapter {
  id        String   @id @default(cuid())
  userId    String
  bookId    String
  name      String
  startPage Int
  endPage   Int
  order     Int
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([bookId])
  @@map("chapter")
}

model ReadingSession {
  id          String   @id @default(cuid())
  userId      String
  bookId      String
  date        DateTime
  minutesRead Int      @default(0)
  pagesRead   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([userId, bookId, date])
  @@index([userId])
  @@index([userId, date])
  @@map("reading_session")
}

model ReadingGoal {
  id          String   @id @default(cuid())
  userId      String   @unique
  targetBooks Int      @default(12)
  year        Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year])
  @@map("reading_goal")
}
